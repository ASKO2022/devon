#!/usr/bin/env bash

MYDEV_DIR=".devon"
if [ -z "$DEVON_HOME" ]; then
  if [ -d "$HOME/.devon" ]; then
    DEVON_HOME="$HOME/.devon"
  elif [ -d "/opt/homebrew/opt/devon" ]; then
    DEVON_HOME="/opt/homebrew/opt/devon"
  elif [ -d "/usr/local/opt/devon" ]; then
    DEVON_HOME="/usr/local/opt/devon"
  else
    DEVON_HOME="$(cd "$(dirname "$0")" && pwd)"
  fi
fi
export DEVON_HOME
TEMPLATES="$DEVON_HOME/templates"
PROJECT=$(basename "$PWD")


config() {
  PROJECT_TYPE="django"

  # Optionaler Parameter: --type=django
  while [[ "$#" -gt 0 ]]; do
    case $1 in
      --type=*) PROJECT_TYPE="${1#*=}";;
    esac
    shift
  done

  echo "üîß Erstelle .devon f√ºr Projekt: $PROJECT (type: $PROJECT_TYPE)"

  DOMAIN="$PROJECT.devon.site"
  echo "üåê Verwende Domain: https://$DOMAIN"

  mkdir -p "$MYDEV_DIR/services"

  # Framework-Config erzeugen
  sed "s/{{PROJECT}}/$PROJECT/" \
    "$TEMPLATES/frameworks/$PROJECT_TYPE/config.yaml.tpl" \
    > "$MYDEV_DIR/config.yaml"

  # Services kopieren
  cp "$TEMPLATES/services/"*.yaml "$MYDEV_DIR/services/"

  PYTHON_VERSION=$(grep python_version "$MYDEV_DIR/config.yaml" | awk '{print $2}')
  sed -i "" "s/{{PYTHON_VERSION}}/$PYTHON_VERSION/g; s/{{PROJECT}}/$PROJECT/g" "$MYDEV_DIR/services/django.yaml"
  sed -i "" "s/{{PROJECT}}/$PROJECT/g" "$MYDEV_DIR/services/postgres.yaml"

  # docker-compose.yaml generieren
  echo "üß© Erstelle neue docker-compose.yaml ..."
  rm -f "$MYDEV_DIR/docker-compose.yaml"

  cat > "$MYDEV_DIR/docker-compose.yaml" <<EOF

services:
EOF

  for FILE in "$MYDEV_DIR"/services/*.yaml; do
    echo "" >> "$MYDEV_DIR/docker-compose.yaml"
    sed 's/^/  /' "$FILE" >> "$MYDEV_DIR/docker-compose.yaml"

  done

  cat >> "$MYDEV_DIR/docker-compose.yaml" <<EOF

volumes:
  ${PROJECT}_dbdata:

networks:
  default:
    name: devon
    external: true
EOF

  grep -v '^domain:' "$MYDEV_DIR/config.yaml" > "$MYDEV_DIR/config.tmp"
  echo "domain: $DOMAIN" >> "$MYDEV_DIR/config.tmp"
  mv "$MYDEV_DIR/config.tmp" "$MYDEV_DIR/config.yaml"

  echo "‚úÖ .devon generiert!"
  echo "PROJECT=$PROJECT" > "$MYDEV_DIR/.env"

}

start() {
  DOMAIN="$PROJECT.devon.site"
  GLOBAL_CERT_DIR="$DEVON_HOME/traefik/global_certs"
  mkdir -p "$GLOBAL_CERT_DIR"

  echo "üöÄ Starte lokales devon Projekt: $PROJECT"
  echo "üåê Domain: $DOMAIN"

  # üîç Pr√ºfe mkcert Installation
  if ! command -v mkcert >/dev/null 2>&1; then
    echo "‚ùå mkcert fehlt. Bitte installiere mit:"
    echo "   brew install mkcert nss && mkcert -install"
    exit 1
  fi

  # üîí SSL-Zertifikat erzeugen (nur falls nicht vorhanden)
  CRT="$GLOBAL_CERT_DIR/${DOMAIN}.crt"
  KEY="$GLOBAL_CERT_DIR/${DOMAIN}.key"
  YAML="$GLOBAL_CERT_DIR/${DOMAIN}.yaml"

  if [ ! -f "$CRT" ]; then
    echo "üîí Erstelle SSL-Zertifikat f√ºr Domain: $DOMAIN ..."
    mkcert -cert-file "$CRT" -key-file "$KEY" "$DOMAIN"
  else
    echo "‚úÖ Zertifikat bereits vorhanden: $CRT"
  fi

  # üåé YAML f√ºr Traefik erzeugen
  cat > "$YAML" <<EOF
tls:
  certificates:
    - certFile: /mnt/devon-global-cache/traefik/certs/${DOMAIN}.crt
      keyFile: /mnt/devon-global-cache/traefik/certs/${DOMAIN}.key
EOF

  # üì¶ Dateien ins Traefik-Volume kopieren
  echo "üì° Kopiere Zertifikate in Traefik-Container ..."
  docker exec devon-traefik mkdir -p /mnt/devon-global-cache/traefik/certs 2>/dev/null || true
  docker cp "$CRT"  devon-traefik:/mnt/devon-global-cache/traefik/certs/
  docker cp "$KEY"  devon-traefik:/mnt/devon-global-cache/traefik/certs/
  docker cp "$YAML" devon-traefik:/mnt/devon-global-cache/traefik/certs/

  echo "‚úÖ Zertifikat aktiv unter: /mnt/devon-global-cache/traefik/certs/${DOMAIN}.crt"

  # üß© Domain in /etc/hosts eintragen
  if ! grep -q "$DOMAIN" /etc/hosts; then
    echo "üß© F√ºge Domain zu /etc/hosts hinzu: $DOMAIN"
    echo "127.0.0.1 $DOMAIN" | sudo tee -a /etc/hosts >/dev/null
  else
    echo "‚úÖ Domain bereits in /etc/hosts"
  fi

  # üß≠ Traefik l√§uft?
  if ! docker ps | grep -q devon-traefik; then
    echo "üåê Starte globalen Traefik-Router ..."
    devon router start
  fi

  # üêç Django + DB starten
  echo "üêç Starte Django + Datenbank ..."
  docker compose -f "$MYDEV_DIR/docker-compose.yaml" up -d --remove-orphans

  echo ""
  echo "‚úÖ Projekt l√§uft unter: https://${DOMAIN}"
  echo "üß≠ Traefik Dashboard:  http://localhost:8090"
}

stop() {
  docker compose -f $MYDEV_DIR/docker-compose.yaml down
}

ssh() {
  docker exec -it ${PROJECT}-django bash
}

create() {
  FRAMEWORK=$(grep framework .devon/config.yaml | awk '{print $2}')
  CREATE_SCRIPT="$TEMPLATES/frameworks/$FRAMEWORK/create.sh"

  if [ ! -f "$CREATE_SCRIPT" ]; then
    echo "‚ùå Framework '$FRAMEWORK' hat keine create.sh"
    exit 1
  fi

  bash "$CREATE_SCRIPT"
  devon config --type=$FRAMEWORK
  devon start

  echo "üåê Starte globalen Router (Traefik), falls er nicht l√§uft..."
  docker ps | grep -q devon-traefik || devon router start

}

delete() {
  echo "üóë  Entferne Projekt-Container und Volumes..."
  docker compose -f $MYDEV_DIR/docker-compose.yaml down -v --remove-orphans
  echo "üìÇ L√∂sche .devon Ordner..."
  rm -rf $MYDEV_DIR
  echo "‚úÖ Projekt vollst√§ndig entfernt."
}

list() {
  echo "üì¶ devon Projekte:"
  echo ""

  # Suche alle Django-Container (auch gestoppte)
  CONTAINERS=$(docker ps -a --format '{{.Names}}' | grep -E '.*-django$')
  
  if [ -z "$CONTAINERS" ]; then
    echo "‚ö†Ô∏è  Keine devon Projekte gefunden."
    exit 0
  fi

  for django in $CONTAINERS; do
    PROJECT_NAME=$(echo "$django" | sed 's/-django$//')
    DB_CONTAINER="${PROJECT_NAME}-db"
    DEVON_DIR="$(docker inspect -f '{{.Config.Labels.devon_dir}}' "$django" 2>/dev/null || echo ".devon")"

    # Status der Container
    DJANGO_STATUS=$(docker inspect -f '{{.State.Status}}' "$django" 2>/dev/null || echo "nicht vorhanden")
    DB_STATUS=$(docker inspect -f '{{.State.Status}}' "$DB_CONTAINER" 2>/dev/null || echo "nicht vorhanden")

    # Port finden (falls l√§uft)
    PORT=$(docker port "$django" 2>/dev/null | head -n 1 | awk -F: '{print $2}')

    # Domain aus config.yaml (falls vorhanden)
    DOMAIN=""
    if [ -f "$PROJECT_NAME/.devon/config.yaml" ]; then
      DOMAIN=$(grep '^domain:' "$PROJECT_NAME/.devon/config.yaml" | awk '{print $2}')
    elif [ -f ".devon/config.yaml" ]; then
      DOMAIN=$(grep '^domain:' ".devon/config.yaml" | awk '{print $2}')
    fi

    # Volume suchen
    VOLUME=$(docker inspect -f '{{range .Mounts}}{{.Name}}{{end}}' "${PROJECT_NAME}-db" 2>/dev/null || true)

    echo "üîπ $PROJECT_NAME"
    echo "   Django:   $DJANGO_STATUS"
    echo "   Datenbank: $DB_STATUS"

    if [ -n "$PORT" ]; then
      echo "   URL:      http://localhost:$PORT"
    elif docker ps | grep -q devon-traefik && [ -n "$DOMAIN" ]; then
      echo "   URL:      https://$DOMAIN"
    else
      echo "   URL:      (nicht aktiv)"
    fi

    if [ -n "$VOLUME" ]; then
      echo "   Volume:   $VOLUME"
    else
      echo "   Volume:   (nicht gefunden)"
    fi

    echo ""
  done
}

router() {
  ROUTER_DIR="$DEVON_HOME/traefik"
  COMPOSE_FILE="$ROUTER_DIR/docker-compose.yaml"

  case "$2" in
    start)
      echo "üöÄ Starte globalen Traefik-Router..."
      docker compose -f "$COMPOSE_FILE" up -d
      ;;
    stop)
      echo "üõë Stoppe globalen Traefik-Router..."
      docker compose -f "$COMPOSE_FILE" down
      ;;
    restart)
      echo "üîÅ Starte Router neu..."
      docker compose -f "$COMPOSE_FILE" down
      docker compose -f "$COMPOSE_FILE" up -d
      ;;
    logs)
      echo "üìú Zeige Traefik-Logs..."
      docker logs -f devon-traefik
      ;;
    *)
      echo "Router Befehle:"
      echo "  devon router start     - startet globalen Traefik"
      echo "  devon router stop      - stoppt ihn"
      echo "  devon router restart   - startet neu"
      echo "  devon router logs      - zeigt Logs"
      ;;
  esac
}



case "$1" in
  config) config ;;
  start) start ;;
  stop) stop ;;
  ssh) ssh ;;
  create) create ;;
  delete) delete ;;
  list) list ;;
  router) router "$@" ;;
  *)
    echo "Befehle:"
    echo "  devon config  --type=django            - Erzeugt .devon Projekt Setup"
    echo "  devon start                            - Startet Container"
    echo "  devon stop                             - Stoppt Container"
    echo "  devon ssh                              - Shell im Django Container"
    echo "  devon create                           - Erstellt ein neues Django Projekt (backend/)"
    echo "  devon delete                           - Entfernt Container + Volumes + .devon"
    echo "  devon list                             - Zeigt laufende devon Projekte"
    echo "  devon router [start|stop|restart|logs] - Steuert den globalen Traefik-Router"
    ;;
esac
