#!/usr/bin/env bash
# =====================================================================
# DEVON CLI ‚Äì Haupt-Launcher
# L√§dt Libraries, Commands und f√ºhrt Dispatching aus.
# =====================================================================

set -euo pipefail

# ---------------------------------------------------------------------
# üîß DEVON_HOME automatisch erkennen
# ---------------------------------------------------------------------
SCRIPT_PATH="$(realpath "$0" 2>/dev/null || readlink "$0")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

# Wenn wir im Entwicklungsordner sind (z. B. ~/Projects/devon), dort arbeiten
if [[ -d "$SCRIPT_DIR/lib" ]]; then
  DEVON_HOME="$SCRIPT_DIR"
else
  # Sonst Benutzerinstallation (~/.devon) verwenden
  DEVON_HOME="${DEVON_HOME:-$HOME/.devon}"
fi



# ---------------------------------------------------------------------
# üîß Basis-Setup
# ---------------------------------------------------------------------
PROJECT="$(basename "$PWD")"
MYDEV_DIR=".devon"
DEVON_NAME="devon"
DOMAIN_BASE="${DOMAIN_BASE:-devon.site}"
DEVON_VERSION_DEFAULT="0.0.1"

echo "üåê Verwende feste Domain-Basis: ${DOMAIN_BASE}"

# ---------------------------------------------------------------------
# üìö Libraries laden
# ---------------------------------------------------------------------
LIB_DIR="$DEVON_HOME/lib"

if [ -d "$LIB_DIR" ]; then
  for lib in "$LIB_DIR"/*.sh; do
    [ -f "$lib" ] && source "$lib"
  done
fi

# Stelle sicher, dass DEVON_HOME & Templates vorhanden sind
ensure_user_home
TEMPLATES="$DEVON_HOME/templates"

# ---------------------------------------------------------------------
# ‚öôÔ∏è Commands automatisch laden
# ---------------------------------------------------------------------
COMMANDS_DIR="$DEVON_HOME/commands"
if [ -d "$COMMANDS_DIR" ]; then
  for file in "$COMMANDS_DIR"/*.sh; do
    [ -f "$file" ] || continue
    source "$file"

    # Beispiel: dateiname cert-reload.sh ‚Üí funktion cert_reload
    cmd_name="$(basename "$file" .sh)"     # cert-reload
    fn_name="${cmd_name//-/_}"             # cert_reload

    # Falls cert_reload existiert, aber cert-reload nicht ‚Üí alias bauen
    if ! declare -F "$cmd_name" >/dev/null 2>&1 && declare -F "$fn_name" >/dev/null 2>&1; then
      eval "$cmd_name() { $fn_name \"\$@\"; }"
    fi
  done
fi

# ---------------------------------------------------------------------
# üß≠ Command-Dispatcher
# ---------------------------------------------------------------------
COMMAND="${1:-}"
shift || true

if [ -z "$COMMAND" ]; then
  echo "devon ‚Äì gib 'devon help' f√ºr alle Befehle ein."
  echo "Beispiele: 'devon config --type=django', 'devon start'"
  exit 0
fi

# Pr√ºfen, ob Funktion existiert
if declare -F "$COMMAND" >/dev/null 2>&1; then
  "$COMMAND" "$@"
else
  echo "‚ùå Unbekanntes Kommando: '$COMMAND'"
  echo "Tipp: 'devon help'"
  exit 1
fi
